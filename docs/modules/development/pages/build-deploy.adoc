//
// Copyright 2025 The Apache Software Foundation
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

= Build and Deployment
ifndef::env-site[:toc:]
ifndef::env-site[:toclevels: 3]

This page documents how to build and deploy the maven-mcps documentation site.

== Prerequisites

* Node.js (for npx/Antora)
* netlify-cli (`npm install -g netlify-cli`) - for deployment only

== Makefile Targets

The project includes a `Makefile` in the repository root for common tasks:

[cols="1,3"]
|===
| Target | Description

| `make build-local`
| Build for local development (no edit URLs) [default]

| `make build-remote`
| Build for remote deployment (with GitHub edit URLs)

| `make clean`
| Remove build artifacts (`./build/` directory)

| `make deploy`
| Build and deploy to Netlify (production)

| `make deploy-preview`
| Build and deploy a draft preview to Netlify (unique URL per deploy)

| `make deploy-branch`
| Build and deploy a branch preview (stable URL based on branch name)

| `make help`
| Show available targets
|===

== Building the Site

=== Local Development

To build the documentation site for local development:

[source,bash]
----
make build-local
----

This runs Antora with `antora-local-playbook.yml` and generates the site in `./build/local-site/`.
Edit URLs are disabled in local builds.

=== Remote Deployment

To build for remote deployment (Netlify, GitHub Pages):

[source,bash]
----
make build-remote
----

This runs Antora with `antora-playbook.yml` and generates the site in `./build/remote-site/`.
Edit URLs point to GitHub with the current branch.

=== Running Antora Directly

You can also run Antora directly:

[source,bash]
----
# Local build
npx antora antora-local-playbook.yml

# Remote build (CI=true required for GitHub edit URLs)
CI=true npx antora --url https://maven-mcps.netlify.app antora-playbook.yml
----

NOTE: The `CI=true` environment variable is required for remote builds.
When Antora reads from local worktrees, it defaults to `file://` edit URLs.
Setting `CI=true` forces Antora to use the configured `edit_url` pointing to GitHub.
In most CI environments (GitHub Actions, Netlify, etc.), this variable is already set.

== Deploying to Netlify

=== Environment Variables

Deployment requires two environment variables:

`NETLIFY_AUTH_TOKEN`::
Your Netlify personal access token.
Generate one at https://app.netlify.com/user/applications#personal-access-tokens[Netlify User Settings].

`NETLIFY_PROJECT_ID`::
The Netlify site ID.
Find this in your site's settings under "Site information".

=== Production Deployment

Deploy to production (publishes to the live site URL):

[source,bash]
----
export NETLIFY_AUTH_TOKEN="your-token"
export NETLIFY_PROJECT_ID="your-site-id"
make deploy
----

=== Preview Deployment

Deploy a draft preview (generates a unique preview URL):

[source,bash]
----
make deploy-preview
----

This is useful for one-off reviews before publishing to production.

=== Branch Preview Deployment

Deploy a branch preview with a stable URL based on the current branch name:

[source,bash]
----
make deploy-branch
----

The branch name is determined automatically from `git branch --show-current`.
Slashes are replaced with dashes to form a valid URL alias.

This creates a predictable URL like `https://<branch-name>--maven-mcps.netlify.app`.
Subsequent deploys from the same branch update the same URL, making it ideal for ongoing review during feature development.

Example: If you're on branch `feature/my-feature`, the deploy URL becomes `https://feature-my-feature--maven-mcps.netlify.app`.

== Local Preview Server

For local development with live preview, use a local HTTP server:

[source,bash]
----
make build-local
cd build/local-site
python -m http.server 8000
----

Then open http://localhost:8000 in your browser.

== Playbook Configuration

The project uses two Antora playbooks:

`antora-local-playbook.yml`::
For local development.
Disables edit URLs.
Outputs to `./build/local-site/`.

`antora-playbook.yml`::
For remote deployment.
Edit URLs point to GitHub using `+{refname}+` for the current branch.
Outputs to `./build/remote-site/`.

Both playbooks:

* Read from the working directory (via `worktrees: true`)
* Include both the umbrella docs and mail-mcp component
* Use supplemental UI files for custom header styling

== Related Documentation

* xref:development:prerequisites.adoc[Development Prerequisites]
* xref:development:adr/0004-documentation-restructuring.adoc[ADR-0004: Documentation Restructuring]
